<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QBReader Practice (Local)</title>
  <style>
    :root {
      --bg: #222;
      --panel: #333;
      --text: #ddd;
      --accent: #f57c00;
      --accent-hover: #e65100;
      --border: #555;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background-color: #1a1a1a;
      color: var(--text);
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
    }

    .controls-container {
      background: var(--bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    @media (max-width: 768px) {
      .controls-container {
        padding: 15px;
      }
    }

    .selector-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
      min-height: 400px; 
    }

    @media (max-width: 768px) {
      .selector-grid {
        grid-template-columns: 1fr;
        min-height: auto;
        gap: 15px;
      }
    }

    .column-header {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 1.1rem;
      color: #fff;
    }

    .button-stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-btn {
      background: var(--panel);
      color: #aaa;
      border: 1px solid var(--border);
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
      font-size: 0.95rem;
      user-select: none;
    }

    .filter-btn:hover {
      border-color: #888;
      color: #fff;
    }

    .filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      font-weight: bold;
      box-shadow: 0 0 8px rgba(245, 124, 0, 0.4);
    }

    .top-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .top-controls {
        gap: 10px;
      }

      .top-controls select,
      .top-controls .action-btn {
        font-size: 0.85rem;
        padding: 8px 12px;
      }

      .score-display {
        font-size: 1.1rem;
        width: 100%;
        margin-left: 0;
        text-align: center;
      }
    }

    select, .action-btn {
      padding: 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: white;
      font-size: 0.95rem;
    }

    .action-btn {
      background: #00796b;
      border: none;
      cursor: pointer;
      font-weight: bold;
      padding: 10px 20px;
    }
    .action-btn:disabled { background: #444; cursor: not-allowed; }
    
    #buzz { background: #d32f2f; }
    #correct { background: #2e7d32; }
    #incorrect { background: #c62828; }

    .score-display {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--accent);
      margin-left: auto;
    }

    .judgment-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    @media (max-width: 480px) {
      .judgment-buttons {
        flex-direction: column;
      }

      .judgment-buttons .action-btn {
        width: 100%;
      }
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .slider-container input[type="range"] {
      width: 150px;
    }

    @media (max-width: 480px) {
      .slider-container {
        width: 100%;
        justify-content: space-between;
      }

      .slider-container input[type="range"] {
        width: 100px;
      }
    }

    .slider-container label {
      font-size: 0.9rem;
      color: #aaa;
    }

    .game-area {
      background: var(--bg);
      padding: 30px;
      border-radius: 8px;
      margin-top: 20px;
      border: 1px solid var(--border);
      min-height: 150px;
    }

    @media (max-width: 768px) {
      .game-area {
        padding: 15px;
      }

      #question-text {
        font-size: 1rem;
      }

      #answer-text {
        font-size: 1.1rem;
      }
    }
    
    .hidden { display: none; }
    .status-text { color: #888; font-style: italic; margin-bottom: 10px; display: block;}
    
    #question-text { font-size: 1.2rem; line-height: 1.6; color: #eee; }
    #answer-text { font-size: 1.3rem; color: var(--accent); font-weight: bold; }

    .stats-panel {
      background: var(--bg);
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      border: 1px solid var(--border);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    @media (max-width: 768px) {
      .stats-panel {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      .stats-panel {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .stat-item {
      text-align: center;
    }

    .stat-label {
      color: #888;
      font-size: 0.85rem;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
    }

    .stat-value.positive { color: #4caf50; }
    .stat-value.negative { color: #f44336; }
  </style>
</head>
<body>

<div class="controls-container">
  <div class="top-controls">
    <select id="difficulty">
      <option value="">Any Difficulty</option>
      <option value="1">1 – Middle School</option>
      <option value="2">2 – Easy High School</option>
      <option value="3">3 – High School Regular</option>
      <option value="4">4 – High School Hard</option>
      <option value="5">5 – High School National</option>
      <option value="6">6 – ● (One Dot)</option>
      <option value="7">7 – ●● (Two Dot)</option>
      <option value="8">8 – ●●● (Three Dot)</option>
      <option value="9">9 – ●●●● (Four Dot)</option>
      <option value="10">10 – Open</option>
    </select>
    <button id="start" class="action-btn">Next Tossup (N)</button>
    <button id="buzz" class="action-btn" disabled>Buzz (Space)</button>
    <div class="slider-container">
      <label for="speed-slider">Speed:</label>
      <input type="range" id="speed-slider" min="0.5" max="2" step="0.1" value="1.1">
      <span id="speed-value">1.1x</span>
    </div>
    <div id="filter-summary" style="color:#aaa; font-size: 0.9rem;">No filters selected</div>
    <div class="score-display">Score: <span id="score">0</span></div>
  </div>
</div>

<main class="game-area">
  <span id="status-text" class="status-text">Ready</span>
  <div id="question-meta" style="margin-bottom:10px; color: #888; font-size: 0.8rem;"></div>
  <div id="question-text"></div>
  <div id="answer-box" class="hidden" style="margin-top:20px; border-top:1px solid #444; padding-top:10px;">
    <div style="color:#aaa; font-size:0.9rem;">ANSWER:</div>
    <div id="answer-text"></div>
    <div class="judgment-buttons">
      <button id="correct" class="action-btn">Correct ✓</button>
      <button id="incorrect" class="action-btn">Incorrect ✗</button>
    </div>
  </div>
</main>

<div class="stats-panel">
  <div class="stat-item">
    <div class="stat-label">Accuracy</div>
    <div class="stat-value" id="accuracy">0%</div>
  </div>
  <div class="stat-item">
    <div class="stat-label">Correct</div>
    <div class="stat-value positive" id="correct-count">0</div>
  </div>
  <div class="stat-item">
    <div class="stat-label">Incorrect</div>
    <div class="stat-value negative" id="incorrect-count">0</div>
  </div>
  <div class="stat-item">
    <div class="stat-label">Powers</div>
    <div class="stat-value" id="power-count">0</div>
  </div>
  <div class="stat-item">
    <div class="stat-label">Total Answered</div>
    <div class="stat-value" id="total-answered">0</div>
  </div>
</div>

<div class="controls-container">
  <div class="selector-grid">
    <div>
      <div class="column-header">Category</div>
      <div id="col-cats" class="button-stack"></div>
    </div>
    <div>
      <div class="column-header">Subcategory</div>
      <div id="col-subs" class="button-stack"></div>
    </div>
    <div>
      <div class="column-header">Alternate Subcategory</div>
      <div id="col-alts" class="button-stack"></div>
    </div>
  </div>
</div>

<script>
// --- Data Structure ---
const taxonomy = {
  "Literature": {
    subs: ["American Literature", "British Literature", "Classical Literature", "European Literature", "World Literature", "Other Literature"],
    alts: ["Drama", "Long Fiction", "Poetry", "Short Fiction", "Misc Literature"]
  },
  "History": {
    subs: ["American History", "Ancient History", "European History", "World History", "Other History"],
    alts: ["Historiography", "Misc History"] 
  },
  "Science": {
    subs: ["Biology", "Chemistry", "Physics", "Other Science"],
    alts: ["Math", "Astronomy", "Computer Science", "Earth Science", "Engineering", "Misc Science"]
  },
  "Fine Arts": {
    subs: ["Visual Fine Arts", "Auditory Fine Arts", "Other Fine Arts"],
    alts: ["Architecture", "Dance", "Film", "Jazz", "Musicals", "Opera", "Photography", "Misc Arts"]
  },
  "Social Science": {
    subs: ["Anthropology", "Economics", "Linguistics", "Psychology", "Sociology", "Other Social Science"],
    alts: ["Social Science (Misc)"] 
  },
  "Religion": { subs: ["Religion"], alts: [] },
  "Mythology": { subs: ["Mythology"], alts: [] },
  "Philosophy": { subs: ["Philosophy"], alts: [] },
  "Current Events": { subs: ["Current Events"], alts: [] },
  "Geography": { subs: ["Geography"], alts: [] },
  "Other Academic": { subs: ["Other Academic"], alts: [] },
  "Pop Culture": { 
    subs: ["Pop Culture", "Movies", "Music", "Sports", "Television", "Video Games"], 
    alts: [] 
  }
};

// --- State ---
const state = {
  categories: new Set(),
  subcategories: new Set(),
  altSubs: new Set()
};

let buzzed = false;
let score = 0;
let ttsSpeed = 1.1;

// Stats tracking
const stats = {
  totalAnswered: 0,
  correct: 0,
  incorrect: 0,
  powers: 0,
  negs: 0
};

// --- Rendering Logic ---

function renderCategories() {
  const container = document.getElementById("col-cats");
  container.innerHTML = "";
  
  Object.keys(taxonomy).forEach(cat => {
    const btn = document.createElement("div");
    btn.className = `filter-btn ${state.categories.has(cat) ? 'active' : ''}`;
    btn.textContent = cat;
    btn.onclick = () => toggleCategory(cat);
    container.appendChild(btn);
  });
}

function renderDynamicColumns() {
  const subContainer = document.getElementById("col-subs");
  const altContainer = document.getElementById("col-alts");
  
  subContainer.innerHTML = "";
  altContainer.innerHTML = "";

  const createBtn = (text, set, parentCat) => {
    // Avoid Duplicates
    if ([...subContainer.children, ...altContainer.children].some(c => c.textContent === text)) return;
    
    const btn = document.createElement("div");
    btn.className = `filter-btn ${state[set].has(text) ? 'active' : ''}`;
    btn.textContent = text;
    
    btn.onclick = () => {
      // Toggle logic
      if (state[set].has(text)) {
        // --- DESELECTION ---
        state[set].delete(text);
        
        // If we deselect "Other Literature", we must hide and clear its Alts
        if (set === 'subcategories' && text === `Other ${parentCat}`) {
          // Clear all alts for this category from state
          taxonomy[parentCat].alts.forEach(a => state.altSubs.delete(a));
        }

      } else {
        // --- SELECTION ---
        state[set].add(text);
        
        // Auto-Enable Parent Category
        if (!state.categories.has(parentCat)) {
          state.categories.add(parentCat);
          renderCategories();
        }
      }
      renderDynamicColumns(); 
      updateSummary();
    };
    
    if (set === 'subcategories') subContainer.appendChild(btn);
    else altContainer.appendChild(btn);
  };

  // 1. Render Subcategories based on Category selection
  state.categories.forEach(cat => {
    if (taxonomy[cat]) {
      taxonomy[cat].subs.forEach(s => createBtn(s, 'subcategories', cat));
    }
  });

  // 2. Render Alts ONLY if "Other [Category]" is selected
  // We iterate through all categories to check if their "Other" trigger is active
  Object.keys(taxonomy).forEach(cat => {
    const triggerSub = `Other ${cat}`; // e.g. "Other Literature"
    
    // Logic: Is "Other Literature" currently selected?
    if (state.subcategories.has(triggerSub)) {
      taxonomy[cat].alts.forEach(a => createBtn(a, 'altSubs', cat));
    }
  });

  if (subContainer.innerHTML === "") subContainer.innerHTML = "<div style='color:#555; text-align:center'>Select a Category</div>";
  if (altContainer.innerHTML === "") altContainer.innerHTML = "<div style='color:#555; text-align:center'>Select 'Other...'</div>";
}

function toggleCategory(cat) {
  if (state.categories.has(cat)) {
    // Cleanup children on deselect
    state.categories.delete(cat);
    taxonomy[cat].subs.forEach(s => state.subcategories.delete(s));
    taxonomy[cat].alts.forEach(a => state.altSubs.delete(a));
  } else {
    state.categories.add(cat);
  }
  renderCategories();
  renderDynamicColumns();
  updateSummary();
}

function updateSummary() {
  const count = state.categories.size + state.subcategories.size + state.altSubs.size;
  document.getElementById("filter-summary").textContent = 
    count === 0 ? "No filters selected (All)" : `${count} filters active`;
}

// --- Game Logic ---

async function fetchTossup() {
  const diff = document.getElementById("difficulty").value;
  let baseUrl = "http://localhost:3000/api/tossup"; 

  const params = [];
  if (diff) params.push(`difficulties=${diff}`);
  if (state.categories.size) params.push(`categories=${encodeURIComponent([...state.categories].join(","))}`);
  if (state.subcategories.size) params.push(`subcategories=${encodeURIComponent([...state.subcategories].join(","))}`);
  if (state.altSubs.size) params.push(`alternateSubcategories=${encodeURIComponent([...state.altSubs].join(","))}`);

  const url = baseUrl + (params.length ? "?" + params.join("&") : "");
  
  try {
    const res = await fetch(url);
    const data = await res.json();
    return data.tossups ? data.tossups[0] : data;
  } catch(e) { console.error(e); return null; }
}

function speak(text, onEnd) {
  const plain = text
    .replace(/<[^>]*>/g, " ")        // Remove HTML tags
    .replace(/\[[^\]]*\]/g, " ")      // Remove square brackets
    .replace(/\([^)]*\)/g, " ")        // Remove parentheses
    .replace(/\{[^}]*\}/g, " ")        // Remove curly braces
    .replace(/\s+/g, " ")
    .trim();
  const u = new SpeechSynthesisUtterance(plain);
  u.rate = ttsSpeed;
  u.onend = onEnd;
  speechSynthesis.speak(u);
}

function updateScore(points) {
  score += points;
  document.getElementById("score").textContent = score;
}

function updateStats() {
  const accuracy = stats.totalAnswered > 0 
    ? ((stats.correct / stats.totalAnswered) * 100).toFixed(1) 
    : 0;

  document.getElementById("accuracy").textContent = accuracy + "%";
  document.getElementById("correct-count").textContent = stats.correct;
  document.getElementById("incorrect-count").textContent = stats.incorrect;
  document.getElementById("power-count").textContent = stats.powers;
  document.getElementById("total-answered").textContent = stats.totalAnswered;
}

function showAnswer(answerText) {
  document.getElementById("answer-text").innerHTML = answerText;
  document.getElementById("answer-box").classList.remove("hidden");
}

let currentAnswer = "";
let powerMarkPassed = false;
let currentQuestionText = "";

document.getElementById("start").onclick = async () => {
  speechSynthesis.cancel();
  buzzed = false;
  powerMarkPassed = false;
  document.getElementById("answer-box").classList.add("hidden");
  document.getElementById("question-text").innerHTML = "Fetching...";
  document.getElementById("status-text").textContent = "Loading...";
  document.getElementById("buzz").disabled = true;

  const data = await fetchTossup();
  
  if (!data || !data.question) {
    document.getElementById("question-text").innerText = "Error: Check localhost server or filters.";
    return;
  }

  currentAnswer = data.answer || data.formatted_answer;
  currentQuestionText = data.question;

  const catInfo = `${data.category} / ${data.subcategory}`;
  const altInfo = data.alternate_subcategory ? ` / ${data.alternate_subcategory}` : "";
  const difficultyMap = {
    1: "MS", 2: "Easy HS", 3: "Reg HS", 4: "Hard HS", 5: "Nat HS",
    6: "●", 7: "●●", 8: "●●●", 9: "●●●●", 10: "Open"
  };
  const diffInfo = data.difficulty ? ` [${difficultyMap[data.difficulty] || data.difficulty}]` : "";
  
  document.getElementById("question-meta").textContent = 
    `${catInfo}${altInfo}${diffInfo}`;
  
  document.getElementById("question-text").innerHTML = "[Question being read...]";
  document.getElementById("status-text").textContent = "Reading...";
  document.getElementById("buzz").disabled = false;

  const sentences = data.question.split(/(?<=[.!?])\s+/);
  let idx = 0;

  const playNext = () => {
    if (buzzed || idx >= sentences.length) {
      if(!buzzed) {
        document.getElementById("question-text").innerHTML = currentQuestionText;
        document.getElementById("status-text").textContent = "Finished.";
        showAnswer(currentAnswer);
      }
      return;
    }
    
    // Check if we've passed the power mark (*)
    const textSoFar = sentences.slice(0, idx + 1).join(" ");
    if (textSoFar.includes("(*)")) {
      powerMarkPassed = true;
    }
    
    speak(sentences[idx], () => { idx++; playNext(); });
  };
  playNext();

  document.getElementById("buzz").onclick = () => {
    buzzed = true;
    speechSynthesis.cancel();
    document.getElementById("question-text").innerHTML = currentQuestionText;
    showAnswer(currentAnswer);
    
    const isPower = currentQuestionText.includes("(*)") && !powerMarkPassed;
    const statusMsg = isPower ? 
      "<span style='color:gold'>POWER BUZZ!</span>" : 
      "<span style='color:red'>BUZZED</span>";
    document.getElementById("status-text").innerHTML = statusMsg;
  };
};

document.getElementById("correct").onclick = () => {
  const isPower = currentQuestionText.includes("(*)") && !powerMarkPassed;
  updateScore(isPower ? 15 : 10);
  
  stats.totalAnswered++;
  stats.correct++;
  if (isPower) stats.powers++;
  updateStats();
  
  document.getElementById("start").click();
};

document.getElementById("incorrect").onclick = () => {
  updateScore(-5);
  
  stats.totalAnswered++;
  stats.incorrect++;
  stats.negs++;
  updateStats();
  
  document.getElementById("start").click();
};

// --- Init ---
renderCategories();
renderDynamicColumns();

document.getElementById("speed-slider").addEventListener("input", (e) => {
  ttsSpeed = parseFloat(e.target.value);
  document.getElementById("speed-value").textContent = ttsSpeed.toFixed(1) + "x";
});

window.addEventListener("keydown", (e) => {
  if (e.key === " " && !document.getElementById("buzz").disabled) {
    e.preventDefault();
    document.getElementById("buzz").click();
  }
  if (e.key === "n" || e.key === "N") {
    e.preventDefault();
    document.getElementById("start").click();
  }
});
</script>
</body>
</html>